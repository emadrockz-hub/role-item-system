- name: Deploy on EC2
  env:
    APP_NAME: role-item-system
    APP_ROOT: /var/www/roleitems
    COMPOSE_FILE: docker-compose.yml
    ENV_FILE: .env
    KEEP_RELEASES: 5
  run: |
    ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=yes \
      ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << SSH
        set -euo pipefail

        # ---- values injected from GitHub runner into the remote script ----
        APP_NAME="${{ env.APP_NAME }}"
        APP_ROOT="${{ env.APP_ROOT }}"
        COMPOSE_FILE="${{ env.COMPOSE_FILE }}"
        ENV_FILE="${{ env.ENV_FILE }}"
        KEEP_RELEASES="${{ env.KEEP_RELEASES }}"

        RELEASES_DIR="$APP_ROOT/releases"
        SHARED_DIR="$APP_ROOT/shared"
        TS="$(date +%Y%m%d%H%M%S)"
        NEW_RELEASE="$RELEASES_DIR/$TS"

        echo "==> Deploying $APP_NAME to $NEW_RELEASE"

        # ---- create dirs ----
        sudo mkdir -p "$NEW_RELEASE" "$SHARED_DIR"

        # ---- extract artifact into the new release ----
        sudo tar -xzf /tmp/deploy.tgz -C "$NEW_RELEASE"

        # ---- write shared env file from secrets (overwrites each deploy) ----
        sudo bash -c 'cat > "$1" <<EOF
MSSQL_SA_PASSWORD=${{ secrets.SA_PASSWORD }}
DB_NAME=${{ secrets.DB_NAME }}
JWT_KEY=${{ secrets.JWT_KEY }}
EOF' _ "$SHARED_DIR/$ENV_FILE"
        sudo chmod 600 "$SHARED_DIR/$ENV_FILE"

        # ---- symlink env into release ----
        sudo ln -sfn "$SHARED_DIR/$ENV_FILE" "$NEW_RELEASE/$ENV_FILE"

        # ---- flip current symlink ----
        sudo ln -sfn "$NEW_RELEASE" "$APP_ROOT/current"

        # ---- sanity checks ----
        if [ ! -f "$APP_ROOT/current/$COMPOSE_FILE" ]; then
          echo "ERROR: $COMPOSE_FILE not found in release. Listing current dir:"
          ls -la "$APP_ROOT/current"
          exit 1
        fi

        # ---- run docker compose ----
        cd "$APP_ROOT/current"
        sudo docker --version
        sudo docker compose version

        sudo docker compose -f "$COMPOSE_FILE" --env-file "$ENV_FILE" up -d --build --remove-orphans

        # ---- keep last N releases ----
        sudo bash -c 'ls -1dt "$1"/* | tail -n +"$2" | xargs -r rm -rf' _ "$RELEASES_DIR" "$((KEEP_RELEASES+1))"

        echo "==> Done. Current -> $(readlink -f "$APP_ROOT/current")"
      SSH
